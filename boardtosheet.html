<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üè≠ Factory Layout Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <!-- Moved script tags for libraries to head for proper loading order -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    /* Global Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* CSS Variables for consistent styling */
    :root {
      --primary-blue: #1e40af;
      --secondary-blue: #3b82f6;
      --light-blue: #dbeafe;
      --dark-blue: #1e3a8a;
      --accent-blue: #60a5fa;
      --white: #ffffff;
      --light-gray: #f8fafc;
      --border-gray: #e2e8f0;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;
    }

    /* Body Styling */
    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(135deg, var(--light-gray) 0%, #e0f2fe 100%);
      min-height: 100vh;
      color: var(--text-dark);
      padding: 0;
      user-select: none;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Header Styling */
    .header {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      padding: 1rem 2rem 1.2rem 2rem;
      border-radius: 16px;
      margin-bottom: 1.2rem;
      box-shadow: var(--shadow-lg);
      color: var(--white);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0;
      line-height: 1;
    }
    .header h1 i {
      font-size: 2.5rem;
      margin-top: 2px;
    }
    .header p {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 300;
      margin: 0;
    }
    .header-menu {
      display: flex;
      gap: 1rem;
    }
    .header-menu-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--white);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      user-select: none;
    }
    .header-menu-btn:hover:not(.active) {
      background: rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }
    .header-menu-btn.active {
      background: var(--white);
      color: var(--primary-blue);
      font-weight: 700;
      cursor: default;
      box-shadow: var(--shadow-lg);
    }

    /* Controls Section (date filters) */
    .controls {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    .input-group i {
      position: absolute;
      left: 10px;
      color: var(--text-light);
      font-size: 1rem;
      pointer-events: none;
    }
    .input-group input {
      padding: 0.5rem 0.75rem 0.5rem 2.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid var(--border-gray);
      outline: none;
      font-family: 'Kanit', sans-serif;
      transition: border-color 0.3s ease;
      width: 150px;
    }
    .input-group input:focus {
      border-color: var(--secondary-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    #btnFilter {
      background: var(--primary-blue);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #btnFilter:hover {
      background: var(--secondary-blue);
    }
    #btnResetLayout {
      background: var(--warning-orange);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      margin-left: auto;
    }
    #btnResetLayout:hover {
      background: #e67e22;
    }

    /* Factory Layout Section */
    .factory-layout {
      background: var(--white);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      position: relative;
      min-height: 80vh;
      overflow: hidden; /* Changed from visible to hidden to ensure children respect bounds */
    }
    .layout-title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 2rem;
      color: var(--text-dark);
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      align-items: center;
    }

    /* New wrapper for aspect ratio control */
    .factory-floor-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio (9/16 * 100%) */
      height: 0; /* Required for padding-bottom trick */
      overflow: hidden;
      border: 3px solid var(--border-gray);
      border-radius: 12px;
      background-color: #f0f0f0; /* Optional: background if image doesn't fill perfectly */
    }

    .factory-floor {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://nicklp-rmt.github.io/D365InventoryData/pic/layout.jpg') no-repeat center center;
      background-size: contain; /* Ensures image is fully visible */
      /* No border or border-radius here, moved to wrapper */
    }

    /* Process Area styles */
    .process-area {
      position: absolute;
      border: 2px solid var(--border-gray);
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.85);
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s ease; /* Removed transform from transition */
      cursor: grab;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 1rem;
      min-width: 150px;
      min-height: 120px;
      user-select: none;
      touch-action: none;
      /* transform property will be set by JavaScript */
    }
    .process-area.dragging {
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 100;
      cursor: grabbing;
    }
    .process-area:hover {
      box-shadow: var(--shadow-lg);
      z-index: 20;
    }
    .process-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      pointer-events: none;
    }
    .process-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      pointer-events: none;
    }
    .process-count {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      pointer-events: none;
      min-height: 30px;
    }
    .process-status {
      font-size: 0.8rem;
      margin-top: 0.25rem;
      opacity: 0.8;
      pointer-events: none;
    }

    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô */
    .powder-mixing { top: 50px; left: 50px; }
    .compact { top: 50px; left: 250px; }
    .sinter-steam { top: 50px; left: 450px; }
    .finishing { top: 50px; left: 650px; }
    .machining { top: 250px; left: 50px; }
    .sub-store { top: 250px; left: 250px; }
    .final-inspection { top: 250px; left: 450px; }
    .magna-flux { top: 250px; left: 650px; }
    .sort { top: 450px; left: 50px; }
    .pack { top: 450px; left: 250px; }
    .rework { top: 450px; left: 450px; }

    /* ‡∏™‡∏µ‡πÅ‡∏•‡∏∞ animation ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô */
    .high-volume {
      border-color: var(--success-green);
      background: linear-gradient(135deg, rgba(236, 253, 245, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-green 2s infinite;
    }
    .medium-volume {
      border-color: var(--warning-orange);
      background: linear-gradient(135deg, rgba(255, 251, 235, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-orange 2s infinite;
    }
    .low-volume {
      border-color: var(--danger-red);
      background: linear-gradient(135deg, rgba(254, 242, 242, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-red 2s infinite;
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
    }
    @keyframes pulse-orange {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(245,158,11,0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
    }

    /* Resize handles */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--primary-blue);
      opacity: 0;
      border-radius: 2px;
      z-index: 25;
      user-select: none;
      transition: opacity 0.3s ease;
      cursor: nwse-resize;
      right: -3px;
      bottom: -3px;
    }
    .process-area:hover .resize-handle {
      opacity: 0.7;
    }
    .resize-handle:hover {
      opacity: 1 !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .factory-floor-wrapper { /* Adjust wrapper for responsiveness */
        padding-bottom: 75%; /* Example for 4:3 aspect ratio on smaller screens if needed */
      }
      .header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .controls {
        justify-content: center;
      }
    }

    /* Loading Overlay Styles (similar to reporttosheet.html) */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      gap: 1rem;
      color: var(--primary-blue);
      font-size: 1.2rem;
      font-weight: 500;
    }

    .loading-overlay i {
      font-size: 3rem;
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-row">
        <h1><i class="fas fa-industry"></i> Factory Layout Dashboard</h1>
        <div id="currentDatetime" style="font-size:1rem; font-weight: 500; opacity: 0.9;"></div>
      </div>
      <div class="header-row">
        <p>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏±‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</p>
        <nav class="header-menu">
          <a href="boardtosheet.html" class="header-menu-btn active" id="btnDashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          <a href="reporttosheet.html" class="header-menu-btn" id="btnSearch"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
        </nav>
      </div>
    </div>

    <div class="controls">
      <div class="input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="text" id="startDate" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" autocomplete="off" />
      </div>
      <div class="input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="text" id="endDate" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î" autocomplete="off" />
      </div>
      <button id="btnFilter">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      <button id="btnResetLayout">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
    </div>

    <div class="factory-layout">
      <div class="layout-title"><i class="fas fa-map"></i> ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</div>
      
      <!-- New wrapper for aspect ratio control -->
      <div class="factory-floor-wrapper">
        <div class="factory-floor">
            <!-- ‡∏õ‡∏∏‡πà‡∏° Fullscreen -->
            <button id="btnFullscreen" title="‡∏î‡∏π‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠" style="position:absolute; top:10px; right:10px; background:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; z-index:30;">
              <i class="fas fa-expand"></i>
            </button>
          
          <div class="process-area powder-mixing high-volume" data-id="powder-mixing">
            <div class="process-icon"><i class="fas fa-flask"></i></div>
            <div class="process-name">‡∏ú‡∏™‡∏°‡∏ú‡∏á</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area compact medium-volume" data-id="compact">
            <div class="process-icon"><i class="fas fa-compress-arrows-alt"></i></div>
            <div class="process-name">Compact</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area sinter-steam high-volume" data-id="sinter-steam">
            <div class="process-icon"><i class="fas fa-fire"></i></div>
            <div class="process-name">Sinter & Steam</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area finishing medium-volume" data-id="finishing">
            <div class="process-icon"><i class="fas fa-gem"></i></div>
            <div class="process-name">Finishing</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area machining high-volume" data-id="machining">
            <div class="process-icon"><i class="fas fa-cog"></i></div>
            <div class="process-name">Machining</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area sub-store medium-volume" data-id="sub-store">
            <div class="process-icon"><i class="fas fa-warehouse"></i></div>
            <div class="process-name">Sub Store</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area final-inspection medium-volume" data-id="final-inspection">
            <div class="process-icon"><i class="fas fa-clipboard-check"></i></div>
            <div class="process-name">Final Inspection</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area magna-flux low-volume" data-id="magna-flux">
            <div class="process-icon"><i class="fas fa-magnet"></i></div>
            <div class="process-name">Magna flux</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area sort medium-volume" data-id="sort">
            <div class="process-icon"><i class="fas fa-sort-amount-down"></i></div>
            <div class="process-name">Sort</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area pack medium-volume" data-id="pack">
            <div class="process-icon"><i class="fas fa-box"></i></div>
            <div class="process-name">Pack</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>
          <div class="process-area rework low-volume" data-id="rework">
            <div class="process-icon"><i class="fas fa-tools"></i></div>
            <div class="process-name">Rework</div>
            <div class="process-count">0</div>
            <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="resize-handle"></div>
          </div>

          <div class="process-area" style="top: 20px; right: 20px; position: absolute; width: 180px;" data-id="legend">
            <div class="process-name">üîµ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</div>
            <div class="process-status" style="font-size: 0.85rem;">
              <div>üü¢ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å &gt; 1000</div>
              <div>üü† ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á 500‚Äì1000</div>
              <div>üî¥ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢ &lt; 500</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay (similar to reporttosheet.html) -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <i class="fas fa-sync-alt"></i>
    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</span>
  </div>

  <script>
    const processList = [
      '‡∏ú‡∏™‡∏°‡∏ú‡∏á', 'Compact', 'Sinter & Steam', 'Finishing',
      'Machining', 'Sub Store', 'Final Inspection',
      'Magna flux', 'Sort', 'Pack', 'Rework'
    ];

    /**
     * Shows the global loading overlay.
     */
    function showLoadingOverlay() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    /**
     * Hides the global loading overlay.
     */
    function hideLoadingOverlay() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function getDataIdFromProcessName(procName) {
      const map = {
        '‡∏ú‡∏™‡∏°‡∏ú‡∏á': 'powder-mixing',
        'Compact': 'compact',
        'Sinter & Steam': 'sinter-steam',
        'Finishing': 'finishing',
        'Machining': 'machining',
        'Sub Store': 'sub-store',
        'Final Inspection': 'final-inspection',
        'Magna flux': 'magna-flux',
        'Sort': 'sort',
        'Pack': 'pack',
        'Rework': 'rework'
      };
      return map[procName] || '';
    }

    async function loadProcessDataWithDateFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      showLoadingOverlay(); // Show global loading overlay

      try {
        const url = 'https://script.google.com/macros/s/AKfycbwYy1acBX-V37hiU8lhTY-9YGWgVjVplQOIzhNg1-cNispv6L43_rCVRXVO-HqAfik/exec?page=getInventory';
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();

        const filtered = data.filter(row => {
          const rawDate = row.Timestamp;
          const dateOnly = new Date(rawDate).toISOString().split('T')[0];
          return (!start || dateOnly >= start) && (!end || dateOnly <= end);
        });

        const countMap = {};
        processList.forEach(p => countMap[p] = 0);

        filtered.forEach(row => {
          if (row.mainProcess && countMap.hasOwnProperty(row.mainProcess)) {
            countMap[row.mainProcess] += Number(row.Quantity || 0);
          }
        });

        processList.forEach(proc => {
          const dataId = getDataIdFromProcessName(proc);
          const el = document.querySelector(`.process-area[data-id="${dataId}"]`);
          if (el) {
            const qty = countMap[proc] || 0;
            el.querySelector('.process-count').textContent = qty.toLocaleString();

            const statusEl = el.querySelector('.process-status');
            el.classList.remove('high-volume', 'medium-volume', 'low-volume');

            if (qty > 1000) {
              el.classList.add('high-volume');
              statusEl.textContent = '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å';
            } else if (qty >= 500) {
              el.classList.add('medium-volume');
              statusEl.textContent = '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
            } else {
              el.classList.add('low-volume');
              statusEl.textContent = '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢';
            }
          }
        });

      } catch (error) {
        console.error('‚ùå Failed to load process data:', error);
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message || String(error)}`,
          confirmButtonColor: '#dc2626',
        });
      } finally {
        hideLoadingOverlay(); // Hide global loading overlay
      }
    }

    function updateDatetime() {
      const el = document.getElementById('currentDatetime');
      const now = new Date();
      el.textContent = now.toLocaleString('th-TH', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    setInterval(updateDatetime, 1000);
    updateDatetime();

    flatpickr('#startDate', { dateFormat: 'Y-m-d' });
    flatpickr('#endDate', { dateFormat: 'Y-m-d' });
    document.getElementById('btnFilter').addEventListener('click', loadProcessDataWithDateFilter);

    document.getElementById('btnResetLayout').addEventListener('click', () => {
      localStorage.clear();
      document.querySelectorAll('.process-area').forEach(card => {
        card.style.transform = `translate(0px, 0px)`;
        card.setAttribute('data-x', '0');
        card.setAttribute('data-y', '0');
        card.style.width = '';
        card.style.height = '';
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.process-area').forEach(card => {
        const id = card.dataset.id;
        const savedPos = localStorage.getItem(`card-pos-${id}`);
        const savedSize = localStorage.getItem(`card-size-${id}`);
        let x = 0, y = 0;

        if (savedPos) {
          try { // Add try-catch for parsing localStorage data
            const loadedPos = JSON.parse(savedPos);
            x = loadedPos.x;
            y = loadedPos.y;
          } catch (e) {
            console.error(`Error parsing saved position for ${id}:`, e);
            localStorage.removeItem(`card-pos-${id}`); // Clear corrupted data
          }
        }

        card.style.transform = `translate(${x}px, ${y}px)`;
        card.setAttribute('data-x', x);
        card.setAttribute('data-y', y);

        if (savedSize) {
          try { // Add try-catch for parsing localStorage data
            const { width, height } = JSON.parse(savedSize);
            card.style.width = width;
            card.style.height = height;
          } catch (e) {
            console.error(`Error parsing saved size for ${id}:`, e);
            localStorage.removeItem(`card-size-${id}`); // Clear corrupted data
          }
        }
      });

      interact('.process-area')
        .draggable({
          inertia: true,
          modifiers: [interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })],
          listeners: {
            start(e) {
              document.body.style.overflow = 'hidden';
              e.target.classList.add('dragging');
            },
            move(e) {
              const target = e.target;
              let x = parseFloat(target.getAttribute('data-x')) || 0;
              let y = parseFloat(target.getAttribute('data-y')) || 0;
              x += e.dx;
              y += e.dy;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            },
            end(e) {
              document.body.style.overflow = '';
              e.target.classList.remove('dragging');
              const target = e.target;
              const pos = {
                x: parseFloat(target.getAttribute('data-x')) || 0,
                y: parseFloat(target.getAttribute('data-y')) || 0
              };
              localStorage.setItem(`card-pos-${target.dataset.id}`, JSON.stringify(pos));
            }
          }
        })
        .resizable({
          edges: { top: true, left: true, right: true, bottom: true },
          modifiers: [
            interact.modifiers.restrictEdges({ outer: 'parent', endOnly: true }),
            interact.modifiers.restrictSize({ min: { width: 100, height: 80 } })
          ],
          listeners: {
            move(e) {
              const target = e.target;
              let x = (parseFloat(target.getAttribute('data-x')) || 0) + e.deltaRect.left;
              let y = (parseFloat(target.getAttribute('data-y')) || 0) + e.deltaRect.top;
              target.style.width = e.rect.width + 'px';
              target.style.height = e.rect.height + 'px';
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            },
            end(e) {
              const target = e.target;
              const size = {
                width: target.style.width,
                height: target.style.height
              };
              localStorage.setItem(`card-size-${target.dataset.id}`, JSON.stringify(size));
              const pos = {
                x: parseFloat(target.getAttribute('data-x')) || 0,
                y: parseFloat(target.getAttribute('data-y')) || 0
              };
              localStorage.setItem(`card-pos-${target.dataset.id}`, JSON.stringify(pos));
            }
          }
        })
        .styleCursor(false);
    });

    // Fullscreen toggle
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnFullscreen');
      if (btn) {
        btn.addEventListener('click', () => {
          // Check if fullscreen is enabled in the current environment
          if (document.fullscreenEnabled) {
            const el = document.querySelector('.factory-layout');
            if (!document.fullscreenElement) {
              el.requestFullscreen?.();
            } else {
              document.exitFullscreen?.();
            }
          } else {
            // Inform the user if fullscreen is not supported
            Swal.fire({
              icon: 'info',
              title: '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö',
              text: '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠',
              confirmButtonColor: '#3b82f6',
            });
          }
        });
      }
    });

    loadProcessDataWithDateFilter();
  </script>
</body>
</html>
