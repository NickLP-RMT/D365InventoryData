<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>📊 รายงาน Inventory TAG</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS Variables for consistent styling */
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --light-blue: #dbeafe;
            --dark-blue: #1e3a8a;
            --accent-blue: #60a5fa;
            --white: #ffffff;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Body Styling */
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Styling */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            padding: 1rem 2rem 1.2rem 2rem;
            border-radius: 16px;
            margin-bottom: 1.2rem;
            box-shadow: var(--shadow-lg);
            color: var(--white);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Header Row (for layout of title/datetime and description/menu) */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Header Title (RMT Inventory TAG Report) */
        .header-title {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
            line-height: 1;
            font-weight: 700;
        }

        .header-title i {
            font-size: 2.5rem;
            margin-top: 2px;
        }

        /* Current Date/Time Display */
        .header-datetime {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.9;
        }

        /* Header Description (System description) */
        .header-description {
            font-size: 1rem;
            margin: 0;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Header Navigation Menu */
        .header-menu {
            display: flex;
            gap: 1rem;
            margin-top: auto;
        }

        .header-menu-btn {
            background: rgba(255 255 255 / 0.2);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--white);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .header-menu-btn:hover:not(.active) {
            background: rgba(255 255 255 / 0.4);
            transform: translateY(-2px);
        }

        .header-menu-btn.active {
            background: var(--white);
            color: var(--primary-blue);
            font-weight: 700;
            cursor: default;
            box-shadow: var(--shadow-lg);
        }

        /* Main Flex Layout (2 columns) - Adjusted to allow single body scrollbar */
        .main-flex {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
            min-height: 420px;
        }

        /* Controls Section (Left Panel) - Adjusted to allow single body scrollbar */
        .controls-section {
            flex: 0 0 20%;
            max-width: 22%;
            min-width: 200px;
            margin-bottom: 0;
            background: var(--white);
            padding: 1rem 1rem 0.75rem 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-gray);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* Tab Container (Right Panel) - Adjusted to allow single body scrollbar */
        .tab-container {
            flex: 1 1 0;
            min-width: 0;
            max-width: 78%;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-gray);
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Tab Content Area - Adjusted to allow single body scrollbar */
        .tab-content {
            flex: 1 1 auto;
            padding: 2rem;
            min-height: 0;
            display: none; /* Default hidden, controlled by JS */
        }

        .tab-content.active {
            display: block; /* Show active tab */
        }

        /* Table Container - Keeps horizontal scroll for wide tables, no vertical scrollbar here */
        .table-container {
            overflow-x: auto;
            max-height: unset;
            overflow-y: unset;
        }

        /* Responsive Adjustments for main layout */
        @media (max-width: 900px) {
            .main-flex {
                flex-direction: column;
                height: auto;
                min-height: unset;
            }
            .controls-section, .tab-container {
                max-width: 100%;
                width: 100%;
                height: auto;
                overflow-y: unset;
            }
            .tab-content {
                max-height: unset;
                overflow-y: unset;
            }
        }

        /* Controls Section (Filters) */
        .controls-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.6rem;
            margin-bottom: 1rem;
        }

        .input-group {
            position: relative;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 0.87rem;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--text-dark);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-group select {
            cursor: pointer;
        }

        .input-group i {
            position: absolute;
            left: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 0.8rem;
        }

        /* Vertical Button Group (Filter/Export Buttons) */
        .button-group.vertical-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            margin-top: 0.6rem;
        }

        .button-group.vertical-buttons .btn {
            width: 100% !important;
            min-width: 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.7rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            transition: background 0.2s, box-shadow 0.2s;
            cursor: pointer;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .button-group.vertical-buttons .btn.btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: #fff;
        }

        .button-group.vertical-buttons .btn.btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
            box-shadow: var(--shadow-lg);
        }

        .button-group.vertical-buttons .btn.btn-secondary {
            background: var(--white);
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .button-group.vertical-buttons .btn.btn-secondary:hover {
            background: var(--primary-blue);
            color: #fff;
        }

        .button-group.vertical-buttons .btn i {
            font-size: 1.1rem;
            margin-right: 0.35rem;
            vertical-align: middle;
            display: inline-block;
        }

        .button-group.vertical-buttons .btn:focus {
            outline: 2px solid var(--secondary-blue);
        }

        /* General button group (if any horizontal buttons were present) */
        .button-group .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Tab Header Styling */
        .tab-header {
            display: flex;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-gray);
        }

        .tab-button {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: inherit;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: var(--white);
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        .tab-button:hover:not(.active) {
            background: rgba(59, 130, 246, 0.05);
            color: var(--primary-blue);
        }

        /* Summary Grid Layout */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Summary Card Styling */
        .summary-card {
            background: linear-gradient(135deg, var(--white) 0%, #f8fafc 100%);
            border: 1px solid var(--border-gray);
            border-radius: 10px;
            padding: 0.9rem 1rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
        }

        .summary-card .icon {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            margin-bottom: 0.65rem;
            color: var(--primary-blue);
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--light-blue) 0%, #bfdbfe 100%);
        }

        .summary-card .title {
            font-size: 0.78rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card .value {
            font-size: 1.32rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-gray);
        }

        th {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: var(--white);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: var(--light-gray);
        }

        /* Loading State for content areas */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--secondary-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Error State */
        .error {
            text-align: center;
            padding: 3rem;
            color: #dc2626;
            font-size: 1.1rem;
        }

        /* No Data State */
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        /* Responsive Adjustments for smaller screens */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            /* Adjust header title size for smaller screens */
            .header-title {
                font-size: 2rem;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                justify-content: center;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            table {
                font-size: 0.8rem;
            }

            th,
            td {
                padding: 0.5rem;
            }
        }

        /* Flatpickr customization */
        .flatpickr-calendar {
            border-radius: 12px !important;
            box-shadow: var(--shadow-lg) !important;
            border: 1px solid var(--border-gray) !important;
        }

        .flatpickr-day.selected {
            background: var(--primary-blue) !important;
            border-color: var(--primary-blue) !important;
        }

        /* Pagination Controls */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-gray);
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            background-color: var(--white);
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .pagination-btn:hover:not(.active):not(:disabled) {
            background-color: var(--light-blue);
            border-color: var(--secondary-blue);
            color: var(--dark-blue);
        }

        .pagination-btn.active {
            background-color: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
            font-weight: 600;
            cursor: default;
        }

        .pagination-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0 1rem;
        }

        /* Dashboard Content (Under Development) */
        #pageDashboard {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--text-light);
            /* Hidden by default */
            display: none;
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
            color: var(--primary-blue);
            font-size: 1.2rem;
            font-weight: 500;
        }

        .loading-overlay i {
            font-size: 3rem;
            animation: spin 1.5s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-row">
                <h1 class="header-title">
                    <i class="fas fa-chart-bar"></i>
                    RMT Inventory TAG Report
                </h1>
                <div id="currentDatetime" class="header-datetime"></div>
            </div>
            <div class="header-row">
                <p class="header-description">
                    ระบบจัดการและรายงานข้อมูล Inventory ส่วนโรงงาน CHP
                </p>
                <nav class="header-menu">
                    <a href="boardtosheet.html" class="header-menu-btn" id="btnDashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a href="reporttosheet.html" class="header-menu-btn" id="btnSearch">
                        <i class="fas fa-search"></i> ค้นหา
                    </a>
                </nav>
            </div>
        </div>

        <div id="pageDashboard" style="display: none;">
            <p>หน้า Dashboard อยู่ระหว่างการพัฒนา...</p>
        </div>

        <div id="pageSearch" style="display: block;">
            <div class="main-flex">
                <aside class="controls-section">
                    <div class="controls-title">
                        <i class="fas fa-filter"></i>
                        ตัวกรองข้อมูล
                    </div>
                    <div class="controls">
                        <div class="input-group">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="text" id="startDate" placeholder="วันที่เริ่ม" />
                        </div>
                        <div class="input-group">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="text" id="endDate" placeholder="วันที่สิ้นสุด" />
                        </div>
                        <div class="input-group">
                            <i class="fas fa-cogs"></i>
                            <select id="mainProcess">
                                <option value="">ทุกกระบวนการ</option>
                                <option value="ผสมผง">ผสมผง</option>
                                <option value="Compact">Compact</option>
                                <option value="Sinter & Steam">Sinter & Steam</option>
                                <option value="Finishing">Finishing</option>
                                <option value="Machining">Machining</option>
                                <option value="Sub Store">Sub Store</option>
                                <option value="Final Inspection">Final Inspection</option>
                                <option value="Magna flux">Magna flux</option>
                                <option value="Sort">Sort</option>
                                <option value="Pack">Pack</option>
                                <option value="Rework">Rework</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-barcode"></i>
                            <input type="text" id="barcodeSearch" placeholder="ค้นหา Barcode..." />
                        </div>
                    </div>
                    <div class="button-group vertical-buttons">
                        <button class="btn btn-primary" onclick="App.loadData()">
                            <i class="fas fa-search"></i>
                            ค้นหา
                        </button>
                        <button class="btn btn-secondary" onclick="App.clearFilters()">
                            <i class="fas fa-eraser"></i>
                            Clear
                        </button>
                        <button class="btn btn-secondary" onclick="App.exportExcel()">
                            <i class="fas fa-file-excel"></i>
                            ดาวน์โหลด Excel
                        </button>
                    </div>
                </aside>

                <section class="tab-container">
                    <div class="tab-header">
                        <button class="tab-button active" id="btnSummaryTab" onclick="App.switchTab('summary', this)">
                            <i class="fas fa-chart-pie"></i>
                            สรุปยอดข้อมูล
                        </button>
                        <button class="tab-button" id="btnDetailsTab" onclick="App.switchTab('details', this)">
                            <i class="fas fa-table"></i>
                            ตารางข้อมูลรายละเอียด
                        </button>
                    </div>
                    <div id="summaryTab" class="tab-content active">
                        <div class="summary-grid" id="summary">
                            </div>
                    </div>
                    <div id="detailsTab" class="tab-content">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-calendar"></i> วันที่</th>
                                        <th><i class="fas fa-barcode"></i> Barcode</th>
                                        <th><i class="fas fa-cogs"></i> กระบวนการหลัก</th>
                                        <th><i class="fas fa-puzzle-piece"></i> กระบวนการย่อย</th>
                                        <th><i class="fas fa-flag"></i> สถานะ</th>
                                        <th><i class="fas fa-hashtag"></i> จำนวน</th>
                                        <th><i class="fas fa-user"></i> ผู้สแกน</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    </tbody>
                            </table>
                        </div>
                        <div id="paginationControls" class="pagination-controls" style="display: none;"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <i class="fas fa-sync-alt"></i>
        <span>กำลังโหลดข้อมูล... กรุณารอสักครู่</span>
    </div>

    <script>
        // Encapsulate all application logic within an IIFE to avoid global scope pollution.
        const App = (function() {
            let allFilteredData = []; // Stores all filtered data
            let currentPage = 1;
            const rowsPerPage = 20; // Number of rows to display per page
            const loadingOverlay = document.getElementById('loadingOverlay');

            // Function to initialize Flatpickr for date inputs
            function setupDatePickers() {
                flatpickr("#startDate", {
                    dateFormat: "Y-m-d",
                    locale: "th" // Requires flatpickr's Thai locale to be loaded if not already
                });
                flatpickr("#endDate", {
                    dateFormat: "Y-m-d",
                    locale: "th"
                });
            }

            // Function to update current date and time in the header
            function updateCurrentDatetime() {
                const datetimeElement = document.getElementById('currentDatetime');
                const now = new Date();
                // Adjust for Thailand's timezone (GMT+7) if needed, otherwise this line can be removed
                // Note: toLocaleString usually handles local timezone, but adding this for clarity
                // now.setHours(now.getHours() + 7); 
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                datetimeElement.textContent = now.toLocaleString('th-TH', options);
            }

            /**
             * Shows the loading overlay.
             */
            function showLoadingOverlay() {
                loadingOverlay.style.display = 'flex';
            }

            /**
             * Hides the loading overlay.
             */
            function hideLoadingOverlay() {
                loadingOverlay.style.display = 'none';
            }

            /**
             * Displays initial messages prompting user to filter and search.
             * This is shown when the page loads for the first time or after a clear filter yields no results.
             */
            function displayInitialMessages() {
                const summaryDiv = document.getElementById('summary');
                const tbody = document.getElementById('tableBody');
                const paginationControls = document.getElementById('paginationControls');

                const messageHtml = `
                    <div class="no-data">
                        <i class="fas fa-filter"></i>
                        <div>กรุณาเลือกตัวกรองข้อมูลที่ต้องการ แล้วกด "ค้นหา"</div>
                    </div>
                `;

                // Display message in summary tab
                summaryDiv.innerHTML = messageHtml;
                
                // Display message in table body (ensure it's valid table HTML)
                tbody.innerHTML = `<tr><td colspan="7">${messageHtml}</td></tr>`; 
                paginationControls.style.display = 'none';
            }

            /**
             * Switches between main application pages (Dashboard/Search).
             * @param {string} pageId - The ID of the page to display (e.g., 'pageDashboard', 'pageSearch').
             */
            function switchMainPage(pageId) {
                const pages = ['pageDashboard', 'pageSearch'];
                pages.forEach((id) => {
                    document.getElementById(id).style.display = 'none'; // Hide all pages
                });
                document.getElementById(pageId).style.display = 'block'; // Show the selected page

                // Update active state for main menu buttons
                document.querySelectorAll('.header-menu-btn').forEach((btn) => {
                    btn.classList.remove('active');
                });
                // Find the button by its ID and add 'active' class
                const targetBtnId = 'btn' + pageId.replace('page', '');
                const targetBtn = document.getElementById(targetBtnId);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }

                // If switching to search page for the first time or without data, show initial message
                if (pageId === 'pageSearch') {
                    // Check if data is already loaded or filters are applied.
                    // If not, display initial message.
                    if (allFilteredData.length === 0 && 
                        !document.getElementById('startDate').value && 
                        !document.getElementById('endDate').value &&
                        !document.getElementById('mainProcess').value &&
                        !document.getElementById('barcodeSearch').value) {
                        displayInitialMessages();
                    } else {
                        // If filters are set or data is present, re-render based on current state
                        updateSummary(allFilteredData);
                        displayTablePage(currentPage);
                    }
                    // Ensure the correct tab is active (default to summary if not explicitly set)
                    const activeTabButton = document.querySelector('.tab-button.active');
                    if (!activeTabButton) { // If no tab is active (e.g., first load)
                         switchTab('summary');
                    }
                }
            }

            /**
             * Switches between tabs within the search page (Summary/Details).
             * @param {string} tabName - The name of the tab to display (e.g., 'summary', 'details').
             * @param {HTMLElement} clickedButtonElement - The button element that was clicked (or null if called internally).
             */
            function switchTab(tabName, clickedButtonElement = null) {
                const summaryTab = document.getElementById('summaryTab');
                const detailsTab = document.getElementById('detailsTab');
                const paginationControls = document.getElementById('paginationControls');

                // Explicitly hide both tab content divs and remove active class from all tab buttons
                summaryTab.style.display = 'none';
                detailsTab.style.display = 'none';
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

                let targetButton;
                if (clickedButtonElement) {
                    targetButton = clickedButtonElement;
                } else {
                    if (tabName === 'summary') {
                        targetButton = document.getElementById('btnSummaryTab');
                    } else if (tabName === 'details') {
                        targetButton = document.getElementById('btnDetailsTab');
                    }
                }

                if (targetButton) {
                    targetButton.classList.add('active');
                }

                if (tabName === 'summary') {
                    summaryTab.style.display = 'block';
                    paginationControls.style.display = 'none';
                } else if (tabName === 'details') {
                    detailsTab.style.display = 'block';
                    paginationControls.style.display = 'flex'; // Only show if data is available
                    displayTablePage(currentPage); // Re-render table when switching to details tab
                }
            }

            /**
             * Clears all filter inputs and reloads data (which will then show initial messages if no filters set).
             */
            function clearFilters() {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('mainProcess').value = '';
                document.getElementById('barcodeSearch').value = '';

                document.getElementById('startDate')._flatpickr?.clear();
                document.getElementById('endDate')._flatpickr?.clear();

                allFilteredData = []; // Clear current data
                currentPage = 1; // Reset to first page
                displayInitialMessages(); // Show initial message
            }

            /**
             * Adjusts timestamp by a given number of hours.
             * Note: This function assumes the input `dateString` is in a format that `new Date()` can parse.
             * For robust timezone handling, consider a dedicated library or ensuring server-side consistency.
             * @param {string} dateString - The date string to adjust.
             * @param {number} hours - The number of hours to add or subtract.
             * @returns {Date} The adjusted Date object.
             */
            function adjustTimeByHours(dateString, hours) {
                const date = new Date(dateString);
                date.setHours(date.getHours() + hours);
                return date;
            }

            /**
             * Extracts the barcode part before a slash, if present.
             * Ensures the input barcode is treated as a string.
             * @param {*} barcode - The raw barcode value (can be string, number, null, undefined).
             * @returns {string} The extracted barcode part or '-' if empty.
             */
            function extractBarcodeBeforeSlash(barcode) {
                const barcodeStr = String(barcode || '').trim();
                if (!barcodeStr) return '-';
                const slashIndex = barcodeStr.indexOf('/');
                return slashIndex !== -1 ? barcodeStr.substring(0, slashIndex) : barcodeStr;
            }

            /**
             * Loads and filters data from the Google Apps Script endpoint.
             */
            async function loadData() {
                const url = 'https://script.google.com/macros/s/AKfycbwYy1acBX-V37hiU8lhTY-9YGWgVjVplQOIzhNg1-cNispv6L43_rCVRXVO-HqAfik/exec?page=getInventory';

                const tbody = document.getElementById('tableBody');
                const summaryDiv = document.getElementById('summary');
                const paginationControls = document.getElementById('paginationControls');

                // Clear previous content and show loading
                tbody.innerHTML = '';
                summaryDiv.innerHTML = '';
                paginationControls.style.display = 'none';
                showLoadingOverlay();

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    const selectedProcess = document.getElementById('mainProcess').value;
                    const barcodeKeyword = document.getElementById('barcodeSearch').value.toLowerCase().trim();

                    allFilteredData = data.filter((item) => {
                        const rawDate = item.Timestamp;
                        // Use a more robust date parsing if Timestamp format is not consistent
                        // For example, if Timestamp is "DD/MM/YYYY HH:MM:SS", parse it
                        // For simplicity, assuming new Date() can parse it (e.g., ISO 8601 or common formats)
                        const itemDate = new Date(rawDate);
                        const dateOnly = itemDate.toISOString().split('T')[0]; // YYYY-MM-DD

                        const matchDate = (!start || dateOnly >= start) && (!end || dateOnly <= end);
                        const matchProcess = !selectedProcess || item.mainProcess === selectedProcess;
                        const itemBarcodeStr = String(item.Barcode || '');
                        const matchBarcode = !barcodeKeyword || (itemBarcodeStr.toLowerCase().includes(barcodeKeyword));
                        
                        return matchDate && matchProcess && matchBarcode;
                    });

                    if (allFilteredData.length === 0) {
                        displayInitialMessages(); // Show "no data" message if filter yields no results
                    } else {
                        updateSummary(allFilteredData);
                        currentPage = 1; // Reset to first page after new data load
                        displayTablePage(currentPage);
                        // Ensure pagination controls are shown only when data is present
                        if (document.getElementById('btnDetailsTab').classList.contains('active')) {
                            paginationControls.style.display = 'flex';
                        }
                    }

                } catch (error) {
                    console.error('Error loading data:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการโหลดข้อมูล',
                        text: `ไม่สามารถดึงข้อมูลจากเซิร์ฟเวอร์ได้: ${error.message || String(error)}`,
                        confirmButtonColor: '#dc2626',
                    });
                    tbody.innerHTML = `<tr><td colspan="7" class="error"><i class="fas fa-exclamation-triangle"></i><div>เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message || String(error)}</div></td></tr>`;
                    summaryDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i><div>เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message || String(error)}</div></div>`;
                    paginationControls.style.display = 'none';
                } finally {
                    hideLoadingOverlay();
                }
            }

            /**
             * Updates the summary cards based on the provided data.
             * @param {Array<Object>} data - The filtered data to summarize.
             */
            function updateSummary(data) {
                const summaryDiv = document.getElementById('summary');
                if (data.length === 0) {
                    summaryDiv.innerHTML = `<div class="no-data"><i class="fas fa-inbox"></i><div>ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div></div>`;
                    return;
                }

                const totalQty = data.reduce((sum, row) => sum + Number(row.Quantity || 0), 0);
                // Count unique barcodes before the slash
                const uniqueBarcodes = new Set(data.map(row => extractBarcodeBeforeSlash(row.Barcode)));
                const totalUniqueBarcodes = uniqueBarcodes.size;

                // Count unique scanners
                const uniqueScanner = [...new Set(data.map((row) => row.Scanner))].length;

                // Group by mainProcess for counts
                const processCounts = data.reduce((acc, item) => {
                    acc[item.mainProcess] = (acc[item.mainProcess] || 0) + 1;
                    return acc;
                }, {});

                let processSummaryHtml = '';
                for (const process in processCounts) {
                    processSummaryHtml += `
                        <div class="summary-card">
                            <div class="icon"><i class="fas fa-cubes"></i></div>
                            <div class="title">รายการใน "${process}"</div>
                            <div class="value">${processCounts[process]} รายการ</div>
                        </div>
                    `;
                }

                summaryDiv.innerHTML = `
                    <div class="summary-card">
                        <div class="icon"><i class="fas fa-box-open"></i></div>
                        <div class="title">ยอดรวมจำนวน</div>
                        <div class="value">${totalQty.toLocaleString()} ชิ้น</div>
                    </div>
                    <div class="summary-card">
                        <div class="icon"><i class="fas fa-tags"></i></div>
                        <div class="title">จำนวน Barcode ไม่ซ้ำ</div>
                        <div class="value">${totalUniqueBarcodes.toLocaleString()} TAG</div>
                    </div>
                    <div class="summary-card">
                        <div class="icon"><i class="fas fa-users"></i></div>
                        <div class="title">จำนวนผู้สแกนไม่ซ้ำ</div>
                        <div class="value">${uniqueScanner.toLocaleString()} คน</div>
                    </div>
                    ${processSummaryHtml}
                `;
            }

            /**
             * Displays a specific page of table data.
             * @param {number} page - The page number to display.
             */
            function displayTablePage(page) {
                const tbody = document.getElementById('tableBody');
                const startIndex = (page - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                const paginatedData = allFilteredData.slice(startIndex, endIndex);

                tbody.innerHTML = ''; // Clear existing table rows

                if (paginatedData.length === 0) {
                    // This case should theoretically be covered by loadData/displayInitialMessages,
                    // but for robustness, handle it here too.
                    tbody.innerHTML = `<tr><td colspan="7" class="no-data"><i class="fas fa-inbox"></i><div>ไม่พบข้อมูลในหน้านี้</div></td></tr>`;
                    document.getElementById('paginationControls').style.display = 'none';
                    return;
                }

                paginatedData.forEach(row => {
                    const tr = document.createElement('tr');
                    // Format Timestamp to display as Date and Time
                    const timestampDate = new Date(row.Timestamp);
                    const formattedDate = timestampDate.toLocaleDateString('th-TH'); // e.g., 25/7/2568
                    const formattedTime = timestampDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // e.g., 15:30:00

                    tr.innerHTML = `
                        <td>${formattedDate}<br><small class="text-light">${formattedTime}</small></td>
                        <td>${row.Barcode || '-'}</td>
                        <td>${row.mainProcess || '-'}</td>
                        <td>${row.subProcess || '-'}</td>
                        <td>${row.Status || '-'}</td>
                        <td>${Number(row.Quantity || 0).toLocaleString()}</td>
                        <td>${row.Scanner || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });

                setupPagination(allFilteredData.length); // Update pagination controls
            }

            /**
             * Sets up the pagination controls based on total data count.
             * @param {number} totalItems - The total number of filtered items.
             */
            function setupPagination(totalItems) {
                const paginationControls = document.getElementById('paginationControls');
                const totalPages = Math.ceil(totalItems / rowsPerPage);

                paginationControls.innerHTML = ''; // Clear existing pagination buttons

                if (totalPages <= 1 && totalItems > 0) { // If only one page, show info but no buttons
                    paginationControls.innerHTML = `<span class="pagination-info">แสดง ${totalItems.toLocaleString()} รายการ</span>`;
                    paginationControls.style.display = 'flex';
                    return;
                } else if (totalItems === 0) { // No data at all
                    paginationControls.style.display = 'none';
                    return;
                }
                
                // Show "Previous" button
                const prevBtn = document.createElement('button');
                prevBtn.classList.add('pagination-btn');
                prevBtn.textContent = 'ย้อนกลับ';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayTablePage(currentPage);
                    }
                };
                paginationControls.appendChild(prevBtn);

                // Add page number buttons (show max 5 buttons, current in middle)
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);

                if (endPage - startPage < 4) { // Adjust if not enough pages around current
                    if (startPage === 1) {
                        endPage = Math.min(totalPages, startPage + 4);
                    } else if (endPage === totalPages) {
                        startPage = Math.max(1, totalPages - 4);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.classList.add('pagination-btn');
                    pageBtn.textContent = i;
                    if (i === currentPage) {
                        pageBtn.classList.add('active');
                    }
                    pageBtn.onclick = () => {
                        currentPage = i;
                        displayTablePage(currentPage);
                    };
                    paginationControls.appendChild(pageBtn);
                }

                // Show "Next" button
                const nextBtn = document.createElement('button');
                nextBtn.classList.add('pagination-btn');
                nextBtn.textContent = 'ถัดไป';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayTablePage(currentPage);
                    }
                };
                paginationControls.appendChild(nextBtn);

                // Add pagination info
                const infoSpan = document.createElement('span');
                infoSpan.classList.add('pagination-info');
                infoSpan.textContent = `หน้า ${currentPage} จาก ${totalPages} (รวม ${totalItems.toLocaleString()} รายการ)`;
                paginationControls.appendChild(infoSpan);

                paginationControls.style.display = 'flex'; // Ensure visible after setup
            }

            /**
             * Exports the currently filtered data to an Excel file.
             */
            function exportExcel() {
                if (allFilteredData.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'ไม่มีข้อมูลให้ส่งออก',
                        text: 'กรุณาค้นหาข้อมูลก่อนทำการดาวน์โหลด Excel',
                        confirmButtonColor: var(--primary-blue),
                    });
                    return;
                }

                showLoadingOverlay();

                try {
                    const ws = XLSX.utils.json_to_sheet(allFilteredData.map(item => ({
                        'วันที่': new Date(item.Timestamp).toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                        'เวลา': new Date(item.Timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                        'Barcode': item.Barcode || '-',
                        'กระบวนการหลัก': item.mainProcess || '-',
                        'กระบวนการย่อย': item.subProcess || '-',
                        'สถานะ': item.Status || '-',
                        'จำนวน': Number(item.Quantity || 0),
                        'ผู้สแกน': item.Scanner || '-',
                    })));

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Inventory_Data");

                    const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                    XLSX.writeFile(wb, `Inventory_Report_${date}.xlsx`);

                    Swal.fire({
                        icon: 'success',
                        title: 'ดาวน์โหลดสำเร็จ!',
                        text: 'ไฟล์ Excel ได้รับการดาวน์โหลดเรียบร้อยแล้ว',
                        showConfirmButton: false,
                        timer: 1500,
                        confirmButtonColor: var(--primary-blue),
                    });

                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาดในการส่งออก Excel',
                        text: `ไม่สามารถสร้างไฟล์ Excel ได้: ${error.message || String(error)}`,
                        confirmButtonColor: '#dc2626',
                    });
                } finally {
                    hideLoadingOverlay();
                }
            }

            // Public methods and properties
            return {
                init: function() {
                    setupDatePickers(); // Initialize date pickers
                    updateCurrentDatetime(); // Set initial datetime
                    setInterval(updateCurrentDatetime, 1000); // Update datetime every second

                    // Set initial page and active menu button
                    // Note: If you want 'Dashboard' as default, change 'pageSearch' to 'pageDashboard' here
                    switchMainPage('pageSearch'); 
                    // Set 'btnSearch' as active from start if 'pageSearch' is the default view
                    document.getElementById('btnSearch').classList.add('active');

                    // Display initial messages for filtering
                    displayInitialMessages();

                    // Set initial tab to summary
                    switchTab('summary');

                    // Attach event listeners for main navigation buttons
                    // (Already done in HTML with onclick, but adding listeners is a cleaner approach)
                    document.getElementById('btnDashboard').addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent default link behavior
                        App.switchMainPage('pageDashboard');
                    });
                    document.getElementById('btnSearch').addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent default link behavior
                        App.switchMainPage('pageSearch');
                    });
                },
                loadData: loadData,
                clearFilters: clearFilters,
                exportExcel: exportExcel,
                switchTab: switchTab, // Make this accessible for HTML onclick
                switchMainPage: switchMainPage // Make this accessible for HTML onclick
            };
        })();

        // Call the init function when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
