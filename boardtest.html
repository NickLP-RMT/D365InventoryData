<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üè≠ Factory Layout Dashboard</title>

  <!-- Font Kanit -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <!-- Flatpickr CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-blue: #1e40af;
      --secondary-blue: #3b82f6;
      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;
      --white: #ffffff;
      --light-gray: #f8fafc;
      --border-gray: #e2e8f0;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(135deg, var(--light-gray) 0%, #e0f2fe 100%);
      min-height: 100vh;
      color: var(--text-dark);
      padding: 0;
      user-select: none;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
      padding: 1rem 2rem 1.2rem 2rem;
      border-radius: 16px;
      margin-bottom: 1.2rem;
      box-shadow: var(--shadow-lg);
      color: var(--white);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 0;
      line-height: 1;
    }
    .header h1 i {
      font-size: 2.5rem;
      margin-top: 2px;
    }
    .header p {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 300;
      margin: 0;
    }
    .header-menu {
      display: flex;
      gap: 1rem;
    }
    .header-menu-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 12px;
      padding: 0.75rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--white);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      user-select: none;
    }
    .header-menu-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.4);
      transform: translateY(-2px);
    }
    .header-menu-btn.active {
      background: var(--white);
      color: var(--primary-blue);
      font-weight: 700;
      cursor: default;
      box-shadow: var(--shadow-lg);
    }

    /* Controls Section (date filters) */
    .controls {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    .input-group i {
      position: absolute;
      left: 10px;
      color: var(--text-light);
      font-size: 1rem;
      pointer-events: none;
    }
    .input-group input {
      padding: 0.5rem 0.75rem 0.5rem 2.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid var(--border-gray);
      outline: none;
      font-family: 'Kanit', sans-serif;
      transition: border-color 0.3s ease;
      width: 150px;
    }
    .input-group input:focus {
      border-color: var(--secondary-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    #btnFilter {
      background: var(--primary-blue);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #btnFilter:hover {
      background: var(--secondary-blue);
    }

    /* Factory Layout Section */
    .factory-layout {
      background: var(--white);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      position: relative;
      min-height: 80vh;
      overflow: visible;
    }
    .layout-title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 2rem;
      color: var(--text-dark);
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      align-items: center;
    }
    .factory-floor {
      position: relative;
      width: 100%;
      height: 750px;
      background: url('https://nicklp-rmt.github.io/D365InventoryData/pic/layout.jpg') no-repeat center center;
      background-size: cover;
      border: 3px solid var(--border-gray);
      border-radius: 12px;
      overflow: visible;
    }

    /* Process Area styles */
    .process-area {
      position: absolute;
      border: 2px solid var(--border-gray);
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.85);
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s ease;
      cursor: default;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 1rem;
      min-width: 150px;
      min-height: 120px;
      user-select: none;
      touch-action: none;
      /* position start from top/left, so don't use transform */
    }
    .process-area.editing {
      cursor: move;
    }
    .process-area:hover {
      box-shadow: var(--shadow-lg);
      z-index: 20;
    }
    .process-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      pointer-events: none;
    }
    .process-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      pointer-events: none;
    }
    .process-count {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      pointer-events: none;
      min-height: 30px;
    }
    .process-status {
      font-size: 0.8rem;
      margin-top: 0.25rem;
      opacity: 0.8;
      pointer-events: none;
    }

    /* ‡∏™‡∏µ‡πÅ‡∏•‡∏∞ animation ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô */
    .high-volume {
      border-color: var(--success-green);
      background: linear-gradient(135deg, rgba(236, 253, 245, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-green 2s infinite;
    }
    .medium-volume {
      border-color: var(--warning-orange);
      background: linear-gradient(135deg, rgba(255, 251, 235, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-orange 2s infinite;
    }
    .low-volume {
      border-color: var(--danger-red);
      background: linear-gradient(135deg, rgba(254, 242, 242, 0.85) 0%, rgba(255, 255, 255, 0.85) 100%);
      animation: pulse-red 2s infinite;
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
    }
    @keyframes pulse-orange {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(245,158,11,0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239,68,68,0); }
    }

    /* ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á process area ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
    .powder-mixing { top: 50px; left: 50px; width: 150px; height: 120px; }
    .compact       { top: 50px; left: 250px; width: 150px; height: 120px; }
    .sinter-steam  { top: 50px; left: 450px; width: 180px; height: 120px; }
    .finishing     { top: 200px; left: 50px; width: 150px; height: 120px; }
    .machining     { top: 200px; left: 250px; width: 150px; height: 120px; }
    .sub-store     { top: 200px; left: 450px; width: 150px; height: 120px; }
    .final-inspection { top: 350px; left: 50px; width: 150px; height: 120px; }
    .magna-flux    { top: 350px; left: 250px; width: 150px; height: 120px; }
    .sort          { top: 350px; left: 450px; width: 150px; height: 120px; }
    .pack          { top: 500px; left: 50px; width: 150px; height: 120px; }
    .rework        { top: 500px; left: 250px; width: 150px; height: 120px; }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö resize */
    .resize-handle {
      position: absolute;
      background: var(--primary-blue);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      user-select: none;
    }
    .process-area:hover .resize-handle {
      opacity: 0.6;
    }

    .resize-se {
      bottom: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      cursor: se-resize;
      border-radius: 0 0 12px 0;
    }
    .resize-s {
      bottom: -3px;
      left: 50%;
      width: 20px;
      height: 6px;
      cursor: s-resize;
      border-radius: 0 0 6px 6px;
      transform: translateX(-50%);
    }
    .resize-e {
      right: -3px;
      top: 50%;
      width: 6px;
      height: 20px;
      cursor: e-resize;
      border-radius: 0 6px 6px 0;
      transform: translateY(-50%);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .factory-floor {
        height: 500px;
        transform: scale(0.8);
        transform-origin: top left;
      }
      .header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .controls {
        justify-content: center;
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-row">
        <h1><i class="fas fa-industry"></i> Factory Layout Dashboard</h1>
        <div id="currentDatetime" style="font-size:1rem; font-weight: 500; opacity: 0.9;"></div>
      </div>
      <div class="header-row">
        <p>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏±‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô CHP</p>
        <nav class="header-menu">
          <a href="boardtest.html" class="header-menu-btn active" id="btnDashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          <a href="reporttest.html" class="header-menu-btn" id="btnSearch"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
        </nav>
      </div>
    </div>

    <!-- Controls (date filter) -->
    <div class="controls">
      <div class="input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="text" id="startDate" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" autocomplete="off" />
      </div>
      <div class="input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="text" id="endDate" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î" autocomplete="off" />
      </div>
      <button id="btnFilter">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>

    <div class="factory-layout">
      <div class="layout-title"><i class="fas fa-map"></i> ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</div>
      <div class="factory-floor">
        <!-- Process Areas -->
        <div class="process-area powder-mixing high-volume" data-id="powder-mixing">
          <div class="process-icon"><i class="fas fa-flask"></i></div>
          <div class="process-name">‡∏ú‡∏™‡∏°‡∏ú‡∏á</div>
          <div class="process-count">0</div>
          <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="resize-handle resize-se"></div>
          <div class="resize-handle resize-s"></div>
          <div class="resize-handle resize-e"></div>
        </div>
        <div class="process-area compact medium-volume" data-id="compact">
          <div class="process-icon"><i class="fas fa-compress-arrows-alt"></i></div>
          <div class="process-name">Compact</div>
          <div class="process-count">0</div>
          <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="resize-handle resize-se"></div>
          <div class="resize-handle resize-s"></div>
          <div class="resize-handle resize-e"></div>
        </div>
        <div class="process-area sinter-steam high-volume" data-id="sinter-steam">
          <div class="process-icon"><i class="fas fa-fire"></i></div>
          <div class="process-name">Sinter & Steam</div>
          <div class="process-count">0</div>
          <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="resize-handle resize-se"></div>
          <div class="resize-handle resize-s"></div>
          <div class="resize-handle resize-e"></div>
        </div>
        <div class="process-area finishing medium-volume" data-id="finishing">
          <div class="process-icon"><i class="fas fa-gem"></i></div>
          <div class="process-name">Finishing</div>
          <div class="process-count">0</div>
          <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="resize-handle resize-se"></div>
          <div class="resize-handle resize-s"></div>
          <div class="resize-handle resize-e"></div>
        </div>
        <div class="process-area machining high-volume" data-id="machining">
          <div class="process-icon"><i class="fas fa-cog"></i></div>
          <div class="process-name">Machining</div>
          <div class="process-count">0</div>
          <div class="process-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="resize-handle resize-se"></div>
          <div class="resize-handle resize-s"></div>
          <div class="resize-handle resize-e"></div>
        </div>
        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° process ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°) -->
      </div>
    </div>
  </div>

  <!-- Script dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script>
    // Supabase client config (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö key ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á)
    const supabaseClient = supabase.createClient(
      'https://fvjminqjxfracpvdbjly.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2am1pbnFqeGZyYWNwdmRiamx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTY4NTMsImV4cCI6MjA2ODczMjg1M30.N3X8-qSRQHa7FPIpbDlfL5ewY5_JeCShAuARczfmLgE'
    );

    const processList = [
      '‡∏ú‡∏™‡∏°‡∏ú‡∏á',
      'Compact',
      'Sinter & Steam',
      'Finishing',
      'Machining',
      'Sub Store',
      'Final Inspection',
      'Magna flux',
      'Sort',
      'Pack',
      'Rework'
    ];

    function getDataIdFromProcessName(procName) {
      const map = {
        '‡∏ú‡∏™‡∏°‡∏ú‡∏á': 'powder-mixing',
        'Compact': 'compact',
        'Sinter & Steam': 'sinter-steam',
        'Finishing': 'finishing',
        'Machining': 'machining',
        'Sub Store': 'sub-store',
        'Final Inspection': 'final-inspection',
        'Magna flux': 'magna-flux',
        'Sort': 'sort',
        'Pack': 'pack',
        'Rework': 'rework'
      };
      return map[procName] || '';
    }

    async function loadProcessDataWithDateFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      try {
        let query = supabaseClient.from('inventory_tags').select('main_process, quantity');

        if (start) query = query.gte('created_at', start);
        if (end) query = query.lte('created_at', end);

        const { data, error } = await query;

        if (error) {
          console.error('Error loading filtered data:', error);
          return;
        }

        const countMap = {};
        processList.forEach(p => countMap[p] = 0);

        data.forEach(row => {
          if (row.main_process && countMap.hasOwnProperty(row.main_process)) {
            countMap[row.main_process] += Number(row.quantity) || 0;
          }
        });

        processList.forEach(proc => {
          const dataId = getDataIdFromProcessName(proc);
          const el = document.querySelector(`.process-area[data-id="${dataId}"]`);
          if (el) {
            const countEl = el.querySelector('.process-count');
            if (countEl) {
              const qty = countMap[proc] || 0;
              countEl.textContent = qty.toLocaleString();

              // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
              el.classList.remove('high-volume', 'medium-volume', 'low-volume');
              if (qty > 1000) {
                el.classList.add('high-volume');
              } else if (qty >= 500) {
                el.classList.add('medium-volume');
              } else {
                el.classList.add('low-volume');
              }
            }
          }
        });
      } catch (err) {
        console.error('Error querying supabase:', err);
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô header
    function updateDatetime() {
      const el = document.getElementById('currentDatetime');
      const now = new Date();
      el.textContent = now.toLocaleString('th-TH', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    setInterval(updateDatetime, 1000);
    updateDatetime();

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î flatpickr ‡∏ö‡∏ô input
    flatpickr('#startDate', { dateFormat: 'Y-m-d' });
    flatpickr('#endDate', { dateFormat: 'Y-m-d' });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    document.getElementById('btnFilter').addEventListener('click', loadProcessDataWithDateFilter);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡πÑ‡∏°‡πà‡∏°‡∏µ filter)
    loadProcessDataWithDateFilter();

    // --- Manual drag and resize functions ---

    let editMode = false; // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ô‡∏µ‡πâ)

    // ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î enable drag ‡πÅ‡∏•‡∏∞ resize ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏°‡∏î edit ‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πá‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggle ‡πÑ‡∏î‡πâ

    function enableDrag(element) {
      if (element._dragging) return;

      let offsetX, offsetY;

      function onMouseDown(e) {
        if (!editMode) return;
        if (e.target.classList.contains('resize-handle')) return;
        e.preventDefault();
        offsetX = e.clientX - element.offsetLeft;
        offsetY = e.clientY - element.offsetTop;
        element.style.zIndex = 1000;

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }
      function onMouseMove(e) {
        let newLeft = e.clientX - offsetX;
        let newTop = e.clientY - offsetY;

        // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å container
        const container = element.parentElement;
        const elRect = element.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        newLeft = Math.max(0, Math.min(newLeft, container.clientWidth - elRect.width));
        newTop = Math.max(0, Math.min(newTop, container.clientHeight - elRect.height));

        element.style.left = newLeft + 'px';
        element.style.top = newTop + 'px';
      }
      function onMouseUp() {
        element.style.zIndex = '';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      element.addEventListener('mousedown', onMouseDown);
      element._dragging = true;
      element._dragOnMouseDown = onMouseDown;
    }

    function disableDrag(element) {
      if (!element._dragging) return;
      element.removeEventListener('mousedown', element._dragOnMouseDown);
      element._dragging = false;
    }

    function enableResize(element) {
      if (element._resizing) return;

      let currentHandle = null;
      let startX, startY, startWidth, startHeight;

      function onMouseDown(e) {
        if (!editMode) return;
        e.preventDefault();
        currentHandle = e.target;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = element.offsetWidth;
        startHeight = element.offsetHeight;
        element.style.zIndex = 1000;

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }
      function onMouseMove(e) {
        if (!currentHandle) return;

        let dx = e.clientX - startX;
        let dy = e.clientY - startY;

        if (currentHandle.classList.contains('resize-se')) {
          element.style.width = (startWidth + dx) + 'px';
          element.style.height = (startHeight + dy) + 'px';
        } else if (currentHandle.classList.contains('resize-s')) {
          element.style.height = (startHeight + dy) + 'px';
        } else if (currentHandle.classList.contains('resize-e')) {
          element.style.width = (startWidth + dx) + 'px';
        }

        // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
        if (parseInt(element.style.width) < 50) element.style.width = '50px';
        if (parseInt(element.style.height) < 40) element.style.height = '40px';
      }
      function onMouseUp() {
        currentHandle = null;
        element.style.zIndex = '';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      const handles = element.querySelectorAll('.resize-handle');
      handles.forEach(handle => handle.addEventListener('mousedown', onMouseDown));

      element._resizing = true;
      element._resizeHandles = handles;
      element._onResizeMouseDown = onMouseDown;
    }

    function disableResize(element) {
      if (!element._resizing) return;
      element._resizeHandles.forEach(handle => handle.removeEventListener('mousedown', element._onResizeMouseDown));
      element._resizing = false;
    }

    // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° UI ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
    function toggleEditMode() {
      editMode = !editMode;
      console.log(editMode ? 'Edit mode ON' : 'Edit mode OFF');
      document.querySelectorAll('.process-area').forEach(area => {
        if (editMode) {
          area.classList.add('editing');
          enableDrag(area);
          enableResize(area);
        } else {
          area.classList.remove('editing');
          disableDrag(area);
          disableResize(area);
        }
      });
    }

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô DOM (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
    // toggleEditMode();

  </script>
</body>
</html>
